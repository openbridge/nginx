##############################################
# Utility Locations
##############################################

# Favicon
location = /favicon.ico {
    log_not_found off;
    access_log off;
    expires $expires;
}

# Robots.txt
location = /robots.txt {
    allow all;
    log_not_found off;
    access_log off;
}

# ACME Challenge for Let's Encrypt
location ^~ /.well-known/acme-challenge/ {
    allow all;
}

##############################################
# WordPress Specific Allowances
##############################################

# WordPress REST API - must be defined early to ensure valid API calls are handled correctly
location /wp-json/ {
    try_files $uri $uri/ /index.php$is_args$args;
}

# Allow wp-includes assets (CSS, JS, images, etc.)
location ~* ^/wp-includes/.*\.(js|css|png|jpg|jpeg|gif|ico)$ {
    allow all;
}

##############################################
# Blocking Sensitive Files & Directories
##############################################

# Block sensitive WordPress configuration files
location ~* ^/(wp-config\.php|wp-config-sample\.php)$ {
    return 403;
}

# Block sensitive system files
location ~* ^/(boot\.ini|etc/passwd|self/environ)$ {
    return 403;
}

# Block hidden files and repository directories
# Exclude /wp-admin and /wp-json to avoid blocking legitimate admin/API requests
location ~* ^/(\..*|Entries.*|Repository|Root|Tag|Template|wp-content/uploads/nginx-helper/)$ {
    if ($request_uri !~* ^/(wp-admin|wp-json)) {
        return 403;
    }
}

# Block PHP execution in uploads and similar directories
location ~* ^/(wp-content/uploads|wp-content/uploads/sucuri|wp-content/updraft)/.*\.php$ {
    return 403;
}

##############################################
# Blocking Malicious Patterns
##############################################

# Block potentially malicious patterns (e.g. eval(), phpinfo, etc.)
# Exempt /wp-json requests to ensure valid REST API calls aren’t blocked
location ~* (&pws=0|_vti_|\(null\)|(eval\\(|self/environ|mobiquo|phpinfo|shell\.php|sqlpatch|webshell\.php)) {
    if ($request_uri !~* ^/wp-json/) {
        return 403;
    }
}

# Block SQL injection attempts
# Exempt /wp-json requests so legitimate API calls aren’t affected
location ~* (drop[^-]|insert|md5|select|union|=%27|/'/?) {
    if ($request_uri !~* ^/wp-json/) {
        return 403;
    }
}

##############################################
# Blocking Dangerous File Extensions
##############################################

# Block access to files with dangerous extensions
# Exclude /wp-admin and /wp-json to avoid interfering with valid backend/API functionality
location ~* \.(bak|conf|dist|fla|in[ci]|log|psd|sh|sql|sw[op]|engine|inc|info|install|make|module|profile|test|po|.*sql|tpl\.php|php_|pl|cgi|py|lua|asp|jsp)$ {
    if ($request_uri !~* ^/(wp-admin|wp-json)) {
        return 403;
    }
}
